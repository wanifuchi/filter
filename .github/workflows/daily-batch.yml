name: Daily Stock Data Batch Processing

on:
  # æ¯æ—¥ UTC 2:00 (JST 11:00) ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 2 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

jobs:
  batch-process:
    runs-on: ubuntu-latest
    timeout-minutes: 300 # 5æ™‚é–“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Display batch start time
        run: |
          echo "ğŸš€ ãƒãƒƒãƒå‡¦ç†é–‹å§‹"
          echo "é–‹å§‹æ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "JSTæ›ç®—: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"

      - name: Call batch processing API
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "ğŸ“Š å…¨éŠ˜æŸ„ãƒãƒƒãƒå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $CRON_SECRET" \
            "https://$VERCEL_URL/api/batch-all")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body:"
          echo "$BODY" | jq '.' || echo "$BODY"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ ãƒãƒƒãƒå‡¦ç†ãŒå¤±æ•—ã—ã¾ã—ãŸ (HTTP $HTTP_CODE)"
            exit 1
          fi

          # æˆåŠŸ/å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆã‚’æŠ½å‡º
          SUCCEEDED=$(echo "$BODY" | jq -r '.results.succeeded // 0')
          FAILED=$(echo "$BODY" | jq -r '.results.failed // 0')
          TOTAL=$(echo "$BODY" | jq -r '.results.total // 0')
          DURATION=$(echo "$BODY" | jq -r '.duration_seconds // 0')

          echo ""
          echo "âœ… ãƒãƒƒãƒå‡¦ç†å®Œäº†"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ˆ å‡¦ç†çµæœã‚µãƒãƒªãƒ¼:"
          echo "  â€¢ å¯¾è±¡éŠ˜æŸ„æ•°: $TOTAL"
          echo "  â€¢ æˆåŠŸ: $SUCCEEDED"
          echo "  â€¢ å¤±æ•—: $FAILED"
          echo "  â€¢ å‡¦ç†æ™‚é–“: ${DURATION}ç§’ ($(($DURATION / 60))åˆ†)"
          echo "  â€¢ æˆåŠŸç‡: $(echo "scale=1; $SUCCEEDED * 100 / $TOTAL" | bc)%"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯è©³ç´°ã‚’è¡¨ç¤º
          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "âš ï¸  ã‚¨ãƒ©ãƒ¼è©³ç´°:"
            echo "$BODY" | jq -r '.results.errors[] | "  â€¢ \(.symbol): \(.error)"'
            echo ""
            echo "æ³¨: ä¸€éƒ¨éŠ˜æŸ„ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€å‡¦ç†ã¯ç¶™ç¶šã•ã‚Œã¾ã—ãŸ"
          fi

      - name: Display completion time
        if: always()
        run: |
          echo ""
          echo "ğŸ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†"
          echo "å®Œäº†æ™‚åˆ»: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "JSTæ›ç®—: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ ãƒãƒƒãƒå‡¦ç†ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "è©³ç´°ã¯GitHub Actionsã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          echo "URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
